<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„ØµØ¯Ø§Ø±Ø© - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø±ÙŠØ¹ V8.1</title>
    
    <!-- Ø§Ø³ØªØ®Ø¯Ø§Ù… CDN Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø³Ø±Ø¹Ø© -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Ù…ÙƒØªØ¨Ø© html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* ==================== */
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ */
        /* ==================== */
        * { 
            font-family: 'Noto Sans Arabic', sans-serif;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #f5f7fa;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© - ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù‚Ø·Ø¹ */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { 
                background: white !important; 
                font-size: 12px !important;
                line-height: 1.3 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            @page { 
                margin: 0.5cm !important;
                size: A4 !important;
            }
            
            /* Ù…Ù†Ø¹ Ù‚Ø·Ø¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
            table { 
                page-break-inside: auto !important;
                border-collapse: collapse !important;
                width: 100% !important;
                table-layout: fixed !important;
            }
            
            tr { 
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }
            
            thead { 
                display: table-header-group !important;
            }
            
            tfoot { 
                display: table-footer-group !important;
            }
            
            /* Ù…Ù†Ø¹ Ù‚Ø·Ø¹ Ø§Ù„ØµÙˆØ± */
            img { 
                max-width: 100% !important;
                height: auto !important;
                page-break-inside: avoid !important;
            }
            
            /* Ù…Ù†Ø¹ Ù‚Ø·Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
            .print-section { 
                break-inside: avoid !important;
                margin-bottom: 10px !important;
                page-break-inside: avoid !important;
            }
            
            /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ */
            .print-table { 
                border-collapse: collapse !important;
                width: 100% !important;
                font-size: 11px !important;
                table-layout: fixed !important;
            }
            
            .print-table th, .print-table td { 
                border: 1px solid #ddd !important;
                padding: 4px !important;
                text-align: right !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
            }
            
            .print-table th { 
                background: #f8fafc !important;
                font-weight: bold !important;
            }
            
            /* ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚Ø·Ø¹ Ø¨ÙŠÙ† Ø§Ù„ØµÙÙˆÙ */
            .avoid-break { 
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            
            .page-break { 
                page-break-before: always !important;
            }
        }
        
        .print-only { display: none; }
        
        /* ==================== */
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… */
        /* ==================== */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 12px;
            border: 1px solid #eef2f7;
        }
        
        /* ==================== */
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… */
        /* ==================== */
        
        /* Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: #0d9488;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
            animation: fadeInOut 2s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„Ù„Ù‚ÙˆØ§Ø¦Ù… */
        .transaction-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #eef2f7;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            will-change: transform;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
        .print-container {
            max-width: 21cm !important;
            margin: 0 auto !important;
            padding: 1cm !important;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0d9488;
        }
        
        .print-footer {
            margin-top: 30px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            text-align: center;
            font-size: 10px;
            color: #666;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        
        /* ==================== */
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø© */
        /* ==================== */
        .optimized-list {
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000;
        }
        
        /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d9488;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tab-btn {
            flex: 1;
            text-align: center;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            min-width: 80px;
            margin: 1px;
        }
        
        /* Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø· ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø·ÙÙŠÙØ© */
        .input-field, .select-field {
            transition: all 0.2s ease;
        }
        
        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: #0d9488;
            box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.1);
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            .print-break-avoid {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            
            .print-page-break {
                page-break-before: always !important;
            }
            
            .print-small-text {
                font-size: 9px !important;
            }
            
            .print-no-border {
                border: none !important;
            }
        }
    </style>
</head>
<body class="min-h-screen text-gray-800">

    <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ -->
    <div id="saveIndicator" class="save-indicator">
        <i class="fas fa-save mr-2"></i>ØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    </div>

    <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loader" class="loader">
        <div class="spinner"></div>
        <div class="mt-4 text-primary font-medium" id="loaderText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
    </div>

    <!-- Ø¨Ù‚ÙŠØ© HTML ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¨Ø³ÙŠØ·Ø© -->
    <!-- ================================================ -->
    
<script>
// ============================================
// ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
// ============================================

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
const TX_TYPES = { /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */ };
const DEFERRED_TYPES = { /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */ };
const REPORT_TYPES = [ /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */ ];

// Ù†Ø¸Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù„Ø£Ø¯Ø§Ø¡
let systemData = {
    transactions: [],
    deferred: [],
    archives: [],
    settings: {},
    images: [],
    lastSync: Date.now()
};

// Ù…Ø­ÙˆÙ„Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
let debounceTimer;
let saveTimer;
let selectedReportId = null;
let currentDeferredTab = 'sales';
let currentReport = { type: null, date: null, data: null };

// ============================================
// Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†
// ============================================

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
function loadInitialData() {
    try {
        const txData = localStorage.getItem('sadara_tx');
        const defData = localStorage.getItem('sadara_def');
        const archData = localStorage.getItem('sadara_arch');
        const settingsData = localStorage.getItem('sadara_settings');
        const imagesData = localStorage.getItem('sadara_images');
        
        systemData.transactions = txData ? JSON.parse(txData) : [];
        systemData.deferred = defData ? JSON.parse(defData) : [];
        systemData.archives = archData ? JSON.parse(archData) : [];
        systemData.settings = settingsData ? JSON.parse(settingsData) : {};
        systemData.images = imagesData ? JSON.parse(imagesData) : [];
        systemData.lastSync = Date.now();
        
        console.log('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­:', {
            transactions: systemData.transactions.length,
            deferred: systemData.deferred.length,
            archives: systemData.archives.length,
            images: systemData.images.length
        });
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø³ÙŠØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.', 'error');
        systemData = { transactions: [], deferred: [], archives: [], settings: {}, images: [], lastSync: Date.now() };
    }
}

// Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù‘Ù† Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
function saveData(force = false) {
    if (!force && saveTimer) {
        clearTimeout(saveTimer);
    }
    
    saveTimer = setTimeout(() => {
        try {
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù…
            const txData = JSON.stringify(systemData.transactions);
            const defData = JSON.stringify(systemData.deferred);
            const archData = JSON.stringify(systemData.archives);
            const settingsData = JSON.stringify(systemData.settings);
            const imagesData = JSON.stringify(systemData.images);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
            const totalSize = txData.length + defData.length + archData.length + settingsData.length + imagesData.length;
            if (totalSize > 5 * 1024 * 1024) { // 5MB Ø­Ø¯ Ø£Ù‚ØµÙ‰
                showMessage('ØªØ­Ø°ÙŠØ±: Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©', 'warning');
                autoArchiveOldData();
            }
            
            localStorage.setItem('sadara_tx', txData);
            localStorage.setItem('sadara_def', defData);
            localStorage.setItem('sadara_arch', archData);
            localStorage.setItem('sadara_settings', settingsData);
            localStorage.setItem('sadara_images', imagesData);
            
            systemData.lastSync = Date.now();
            
            // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸
            showSaveIndicator();
            
            console.log('ğŸ’¾ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', {
                transactions: systemData.transactions.length,
                deferred: systemData.deferred.length,
                time: new Date().toLocaleTimeString()
            });
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        }
    }, force ? 0 : 1000); // ØªØ£Ø®ÙŠØ± 1 Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
}

// Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸
function showSaveIndicator() {
    const indicator = document.getElementById('saveIndicator');
    indicator.style.display = 'block';
    setTimeout(() => {
        indicator.style.display = 'none';
    }, 2000);
}

// Ø£Ø±Ø´ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
function autoArchiveOldData() {
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    // Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    const oldTransactions = systemData.transactions.filter(tx => {
        const txDate = new Date(tx.date);
        return txDate < thirtyDaysAgo;
    });
    
    if (oldTransactions.length > 0) {
        const archive = {
            date: thirtyDaysAgo.toISOString().split('T')[0],
            preparer: 'Ù†Ø¸Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ',
            notes: 'Ø£Ø±Ø´ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©',
            transactions: oldTransactions,
            timestamp: new Date().toISOString()
        };
        
        systemData.archives.push(archive);
        systemData.transactions = systemData.transactions.filter(tx => {
            const txDate = new Date(tx.date);
            return txDate >= thirtyDaysAgo;
        });
        
        console.log(`ğŸ“¦ ØªÙ…Øª Ø£Ø±Ø´ÙØ© ${oldTransactions.length} Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø©`);
    }
}

// ============================================
// ØªØ­Ø³ÙŠÙ†Ø§Øª Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
// ============================================

// Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù‚Ø·Ø¹
function printCompleteReport(reportType, data, dateRange) {
    showLoader('Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...');
    
    setTimeout(() => {
        const printWindow = window.open('', '_blank');
        const reportHtml = createPrintableReportHTML(reportType, data, dateRange);
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html dir="rtl">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>ØªÙ‚Ø±ÙŠØ± ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„ØµØ¯Ø§Ø±Ø©</title>
                <style>
                    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© - Ù…Ù†Ø¹ Ø§Ù„Ù‚Ø·Ø¹ */
                    body { 
                        font-family: 'Noto Sans Arabic', sans-serif;
                        padding: 15px;
                        background: white;
                        font-size: 12px;
                        line-height: 1.3;
                        margin: 0;
                        max-width: 21cm;
                    }
                    
                    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 15px;
                        table-layout: fixed;
                        page-break-inside: auto;
                    }
                    
                    th, td {
                        border: 1px solid #ddd;
                        padding: 6px 4px;
                        text-align: right;
                        font-size: 11px;
                        word-wrap: break-word;
                        overflow-wrap: break-word;
                    }
                    
                    th {
                        background-color: #f8fafc;
                        font-weight: bold;
                        color: #0d9488;
                    }
                    
                    /* Ù…Ù†Ø¹ Ù‚Ø·Ø¹ Ø§Ù„ØµÙÙˆÙ */
                    tr {
                        page-break-inside: avoid;
                        page-break-after: auto;
                    }
                    
                    /* Ù…Ù†Ø¹ Ù‚Ø·Ø¹ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
                    h1, h2, h3, h4 {
                        page-break-after: avoid;
                        page-break-inside: avoid;
                    }
                    
                    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© */
                    .stats-grid {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 10px;
                        margin-bottom: 20px;
                        page-break-inside: avoid;
                    }
                    
                    .stat-box {
                        padding: 12px;
                        border-radius: 6px;
                        text-align: center;
                        border: 1px solid #e2e8f0;
                        background: #f8fafc;
                        page-break-inside: avoid;
                    }
                    
                    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
                    @media print {
                        body {
                            padding: 10px;
                            font-size: 11px;
                        }
                        
                        @page {
                            margin: 0.7cm;
                            size: A4;
                        }
                        
                        .page-break {
                            page-break-before: always;
                        }
                        
                        .no-print {
                            display: none !important;
                        }
                        
                        /* Ù…Ù†Ø¹ Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
                        .avoid-break {
                            page-break-inside: avoid !important;
                            break-inside: avoid !important;
                        }
                        
                        /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª */
                        .compact {
                            margin: 5px 0;
                            padding: 5px;
                        }
                        
                        /* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø·ÙˆÙŠÙ„Ø© */
                        .truncate {
                            max-width: 150px;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        }
                    }
                    
                    /* ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
                    .report-header {
                        text-align: center;
                        margin-bottom: 25px;
                        padding-bottom: 15px;
                        border-bottom: 2px solid #0d9488;
                        page-break-after: avoid;
                    }
                    
                    /* ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
                    .report-footer {
                        margin-top: 30px;
                        padding-top: 15px;
                        border-top: 1px solid #ddd;
                        text-align: center;
                        font-size: 10px;
                        color: #666;
                        page-break-before: avoid;
                    }
                    
                    /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
                    .transaction-row {
                        page-break-inside: avoid;
                        break-inside: avoid;
                    }
                    
                    .transaction-row td {
                        font-size: 10px;
                        padding: 4px 3px;
                    }
                    
                    /* Ø£Ù„ÙˆØ§Ù† Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
                    .income { color: #166534; font-weight: bold; }
                    .expense { color: #991b1b; font-weight: bold; }
                    .deferred-sale { color: #166534; }
                    .deferred-purchase { color: #991b1b; }
                    .deferred-return-sale { color: #065f46; }
                    .deferred-return-purchase { color: #b91c1c; }
                </style>
            </head>
            <body>
                ${reportHtml}
                <script>
                    // Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    window.onload = function() {
                        setTimeout(function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 500);
                        }, 500);
                    };
                <\/script>
            </body>
            </html>
        `);
        
        printWindow.document.close();
        hideLoader();
    }, 500);
}

// Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø­Ø³Ù‘Ù†
function createPrintableReportHTML(reportType, data, dateRange) {
    const { startDate, endDate } = dateRange;
    const dateRangeStr = startDate === endDate 
        ? `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${formatDateArabic(startDate)}`
        : `Ø§Ù„ÙØªØ±Ø©: ${formatDateArabic(startDate)} Ø¥Ù„Ù‰ ${formatDateArabic(endDate)}`;
    
    const reportName = REPORT_TYPES.find(r => r.id === reportType)?.name || 'ØªÙ‚Ø±ÙŠØ±';
    
    let html = `
        <div class="report-header avoid-break">
            <h1 style="color: #0d9488; font-size: 22px; margin: 0 0 10px 0;">ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„ØµØ¯Ø§Ø±Ø©</h1>
            <h2 style="color: #333; font-size: 16px; margin: 0 0 15px 0;">${reportName}</h2>
            <div style="color: #666; font-size: 13px;">
                <div>${dateRangeStr}</div>
                <div>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString('ar-EG')}</div>
            </div>
        </div>
    `;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    html += createReportStatsHTML(reportType, data);
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    switch(reportType) {
        case 'daily_cash':
            html += createDailyCashTablesHTML(data);
            break;
        case 'deferred_full':
            html += createDeferredTablesHTML(data);
            break;
        case 'combined':
            html += createDailyCashTablesHTML(data);
            html += '<div class="page-break"></div>';
            html += createDeferredTablesHTML(data);
            break;
        case 'shortages':
            html += createShortagesTableHTML(data);
            break;
        default:
            html += createDailyCashTablesHTML(data);
    }
    
    // ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    html += `
        <div class="report-footer avoid-break">
            <p style="margin: 5px 0;">ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„ØµØ¯Ø§Ø±Ø© - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© V8.1</p>
            <p style="margin: 5px 0;">Ù…ÙØ¹Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${document.getElementById('preparerName').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            <p style="margin: 5px 0;">ÙˆÙ‚Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}</p>
        </div>
    `;
    
    return html;
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
function createReportStatsHTML(reportType, data) {
    const { totals } = data;
    
    let statsHTML = `
        <div class="stats-grid avoid-break">
            <div class="stat-box">
                <div style="font-size: 11px; color: #475569; margin-bottom: 5px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                <div style="font-size: 18px; font-weight: bold; color: #0d9488;">${data.transactions.length}</div>
            </div>
    `;
    
    if (reportType === 'daily_cash' || reportType === 'combined') {
        statsHTML += `
            <div class="stat-box">
                <div style="font-size: 11px; color: #475569; margin-bottom: 5px;">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                <div style="font-size: 18px; font-weight: bold; color: #166534;">${totals.cashIn.toFixed(2)}</div>
            </div>
            <div class="stat-box">
                <div style="font-size: 11px; color: #475569; margin-bottom: 5px;">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                <div style="font-size: 18px; font-weight: bold; color: #991b1b;">${totals.cashOut.toFixed(2)}</div>
            </div>
            <div class="stat-box">
                <div style="font-size: 11px; color: #475569; margin-bottom: 5px;">Ø§Ù„ØµØ§ÙÙŠ</div>
                <div style="font-size: 18px; font-weight: bold; color: ${totals.netCash >= 0 ? '#166534' : '#991b1b'};">${totals.netCash.toFixed(2)}</div>
            </div>
        `;
    }
    
    if (reportType === 'deferred_full' || reportType === 'combined') {
        statsHTML += `
            </div>
            <div class="stats-grid avoid-break" style="margin-top: 15px;">
                <div class="stat-box">
                    <div style="font-size: 11px; color: #475569; margin-bottom: 5px;">Ù…Ø¨ÙŠØ¹Ø§Øª Ø¢Ø¬Ù„Ø©</div>
                    <div style="font-size: 16px; font-weight: bold; color: #166534;">${totals.deferredSales.toFixed(2)}</div>
                </div>
                <div class="stat-box">
                    <div style="font-size: 11px; color: #475569; margin-bottom: 5px;">Ù…Ø´ØªØ±ÙŠØ§Øª Ø¢Ø¬Ù„Ø©</div>
                    <div style="font-size: 16px; font-weight: bold; color: #991b1b;">${totals.deferredPurchases.toFixed(2)}</div>
                </div>
                <div class="stat-box">
                    <div style="font-size: 11px; color: #475569; margin-bottom: 5px;">Ù…Ø±Ø¯ÙˆØ¯ Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                    <div style="font-size: 16px; font-weight: bold; color: #065f46;">${totals.returnSales.toFixed(2)}</div>
                </div>
                <div class="stat-box">
                    <div style="font-size: 11px; color: #475569; margin-bottom: 5px;">Ù…Ø±Ø¯ÙˆØ¯ Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                    <div style="font-size: 16px; font-weight: bold; color: #b91c1c;">${totals.returnPurchases.toFixed(2)}</div>
                </div>
        `;
    }
    
    statsHTML += `</div>`;
    return statsHTML;
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
function createDailyCashTablesHTML(data) {
    const { transactions, summaries } = data;
    
    if (transactions.length === 0) {
        return `
            <div class="avoid-break" style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px; margin: 15px 0;">
                <i class="fas fa-info-circle" style="color: #6b7280; font-size: 24px; margin-bottom: 10px;"></i>
                <div style="color: #6b7280; font-size: 14px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù†Ù‚Ø¯ÙŠØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</div>
            </div>
        `;
    }
    
    let tablesHTML = '';
    
    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
    tablesHTML += `
        <div class="avoid-break">
            <h3 style="color: #0d9488; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin: 20px 0 15px 0;">
                Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© (${transactions.length})
            </h3>
            <table>
                <thead>
                    <tr>
                        <th style="width: 15%;">Ø§Ù„ÙˆÙ‚Øª</th>
                        <th style="width: 20%;">Ø§Ù„Ù†ÙˆØ¹</th>
                        <th style="width: 20%;">Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</th>
                        <th style="width: 35%;">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                        <th style="width: 10%;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶
    const transactionsByDate = {};
    transactions.forEach(tx => {
        if (!transactionsByDate[tx.date]) {
            transactionsByDate[tx.date] = [];
        }
        transactionsByDate[tx.date].push(tx);
    });
    
    Object.keys(transactionsByDate).sort().reverse().forEach(date => {
        const dateTransactions = transactionsByDate[date];
        
        tablesHTML += `
            <tr class="transaction-row">
                <td colspan="5" style="background: #f1f5f9; font-weight: bold; text-align: center;">
                    ${formatDateArabic(date)} (${dateTransactions.length} Ø¹Ù…Ù„ÙŠØ©)
                </td>
            </tr>
        `;
        
        dateTransactions.forEach(tx => {
            const typeInfo = TX_TYPES[tx.type];
            const amountClass = typeInfo?.type === 'in' ? 'income' : 
                               typeInfo?.type === 'out' ? 'expense' : '';
            
            tablesHTML += `
                <tr class="transaction-row">
                    <td>${tx.time || ''}</td>
                    <td>${typeInfo?.label || tx.type}</td>
                    <td>${tx.fund || ''}</td>
                    <td style="max-width: 200px;">${tx.description || ''}</td>
                    <td class="${amountClass}">${tx.amount > 0 ? tx.amount.toFixed(2) : '-'}</td>
                </tr>
            `;
        });
    });
    
    tablesHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
    if (Object.keys(summaries.byFund).length > 0) {
        tablesHTML += `
            <div class="avoid-break" style="margin-top: 20px;">
                <h3 style="color: #0d9488; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin: 20px 0 15px 0;">
                    Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚
                </h3>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 25%;">Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</th>
                            <th style="width: 25%;">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th>
                            <th style="width: 25%;">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</th>
                            <th style="width: 25%;">Ø§Ù„ØµØ§ÙÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        Object.entries(summaries.byFund).forEach(([fund, amounts]) => {
            const netAmount = amounts.in - amounts.out;
            
            tablesHTML += `
                <tr>
                    <td>${fund}</td>
                    <td class="income">${amounts.in.toFixed(2)}</td>
                    <td class="expense">${amounts.out.toFixed(2)}</td>
                    <td style="color: ${netAmount >= 0 ? '#166534' : '#991b1b'}; font-weight: bold;">
                        ${netAmount.toFixed(2)}
                    </td>
                </tr>
            `;
        });
        
        tablesHTML += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    return tablesHTML;
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¢Ø¬Ù„Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
function createDeferredTablesHTML(data) {
    const { deferred } = data;
    
    if (deferred.length === 0) {
        return `
            <div class="avoid-break" style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px; margin: 15px 0;">
                <i class="fas fa-info-circle" style="color: #6b7280; font-size: 24px; margin-bottom: 10px;"></i>
                <div style="color: #6b7280; font-size: 14px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¢Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</div>
            </div>
        `;
    }
    
    let tablesHTML = `
        <div class="avoid-break">
            <h3 style="color: #0d9488; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin: 20px 0 15px 0;">
                Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¢Ø¬Ù„Ø© (${deferred.length})
            </h3>
            <table>
                <thead>
                    <tr>
                        <th style="width: 15%;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th style="width: 20%;">Ø§Ù„Ù†ÙˆØ¹</th>
                        <th style="width: 20%;">Ø§Ù„Ø§Ø³Ù…</th>
                        <th style="width: 35%;">Ø§Ù„ÙˆØµÙ</th>
                        <th style="width: 10%;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¢Ø¬Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const deferredByDate = {};
    deferred.forEach(def => {
        if (!deferredByDate[def.date]) {
            deferredByDate[def.date] = [];
        }
        deferredByDate[def.date].push(def);
    });
    
    Object.keys(deferredByDate).sort().reverse().forEach(date => {
        const dateDeferred = deferredByDate[date];
        
        tablesHTML += `
            <tr class="transaction-row">
                <td colspan="5" style="background: #f1f5f9; font-weight: bold; text-align: center;">
                    ${formatDateArabic(date)} (${dateDeferred.length} Ø¹Ù…Ù„ÙŠØ©)
                </td>
            </tr>
        `;
        
        dateDeferred.forEach(def => {
            const typeClass = def.type === 'def_sale' ? 'deferred-sale' :
                            def.type === 'def_purchase' ? 'deferred-purchase' :
                            def.type === 'def_return_sale' ? 'deferred-return-sale' :
                            def.type === 'def_return_purchase' ? 'deferred-return-purchase' : '';
            
            const typeLabel = DEFERRED_TYPES[def.type]?.label || def.label;
            
            tablesHTML += `
                <tr class="transaction-row">
                    <td>${def.date}</td>
                    <td>${typeLabel}</td>
                    <td>${def.name || ''}</td>
                    <td style="max-width: 200px;">
                        ${def.description || '-'}
                        ${def.reference ? `<br><small>Ù…Ø±Ø¬Ø¹: ${def.reference}</small>` : ''}
                        ${def.percentage && def.percentage !== 100 ? `<br><small>(${def.percentage}%)</small>` : ''}
                    </td>
                    <td class="${typeClass}">${def.amount.toFixed(2)}</td>
                </tr>
            `;
        });
    });
    
    tablesHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    return tablesHTML;
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
function createShortagesTableHTML(data) {
    const shortages = data.transactions.filter(tx => tx.type === 'shortage');
    
    if (shortages.length === 0) {
        return `
            <div class="avoid-break" style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px; margin: 15px 0;">
                <i class="fas fa-check-circle" style="color: #10b981; font-size: 24px; margin-bottom: 10px;"></i>
                <div style="color: #10b981; font-size: 14px; font-weight: bold;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ÙˆØ§Ù‚Øµ Ù…Ø³Ø¬Ù„Ø©</div>
            </div>
        `;
    }
    
    let tableHTML = `
        <div class="avoid-break">
            <h3 style="color: #0d9488; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin: 20px 0 15px 0;">
                ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ§Ù‚Øµ (${shortages.length})
            </h3>
            <table>
                <thead>
                    <tr>
                        <th style="width: 20%;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th style="width: 15%;">Ø§Ù„ÙˆÙ‚Øª</th>
                        <th style="width: 45%;">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø§Ù„Ù†Ø§Ù‚Øµ</th>
                        <th style="width: 20%;">Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    shortages.forEach(tx => {
        tableHTML += `
            <tr class="transaction-row">
                <td>${tx.date}</td>
                <td>${tx.time || ''}</td>
                <td style="color: #dc2626; font-weight: bold;">${tx.description}</td>
                <td>${tx.fund || ''}</td>
            </tr>
        `;
    });
    
    tableHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    return tableHTML;
}

// ============================================
// ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©
// ============================================

// ØªØ­Ø³ÙŠÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function loadDailyTransactions() {
    const list = document.getElementById('txList');
    const empty = document.getElementById('emptyState');
    
    if (!list) return;
    
    if (systemData.transactions.length === 0) {
        list.innerHTML = '';
        empty?.classList.remove('hidden');
        document.getElementById('txCount').textContent = '0 Ø¹Ù…Ù„ÙŠØ©';
        updateBalance(0);
        return;
    }
    
    empty?.classList.add('hidden');
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… DocumentFragment Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
    const fragment = document.createDocumentFragment();
    const recentTxs = systemData.transactions.slice(-100).reverse(); // ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ
    
    let total = 0;
    
    recentTxs.forEach(tx => {
        const typeInfo = TX_TYPES[tx.type];
        
        if (typeInfo.type === 'in') {
            total += tx.amount;
        } else if (typeInfo.type === 'out') {
            total -= tx.amount;
        }
        
        const item = document.createElement('div');
        item.className = `transaction-item ${typeInfo.bg || ''}`;
        item.innerHTML = `
            <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-large">${typeInfo.icon}</span>
                    <span class="text-medium font-medium ${typeInfo.color}">${typeInfo.label}</span>
                    <span class="text-small text-gray-500">${tx.time}</span>
                </div>
                <p class="text-gray-800 text-medium mb-1">${tx.description}</p>
                <p class="text-small text-gray-600">${tx.fund} ${tx.author ? `| ${tx.author}` : ''} | ${tx.date}</p>
            </div>
            <div class="transaction-amount text-right">
                ${tx.amount > 0 ? `<span class="font-medium text-large ${typeInfo.color}">${tx.amount.toFixed(2)}</span>` : ''}
                <button onclick="deleteTransaction(${tx.id})" class="block mt-2 text-gray-400 hover:text-red-500 text-small">
                    <i class="fas fa-trash mr-1"></i>Ø­Ø°Ù
                </button>
            </div>
        `;
        
        fragment.appendChild(item);
    });
    
    list.innerHTML = '';
    list.appendChild(fragment);
    document.getElementById('txCount').textContent = `${systemData.transactions.length} Ø¹Ù…Ù„ÙŠØ©`;
    updateBalance(total);
}

// ØªØ­Ø³ÙŠÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
function addTransaction(e) {
    e.preventDefault();
    
    const type = document.getElementById('typeSelect').value;
    const amount = parseFloat(document.getElementById('amountInput').value) || 0;
    const description = document.getElementById('descInput').value.trim();
    const fund = document.getElementById('fundSelect').value;
    const author = document.getElementById('reportAuthor')?.value?.trim() || '';
    const noAmountTypes = ['shortage', 'alert', 'note'];
    
    // ØªØ­Ù‚Ù‚ Ø³Ø±ÙŠØ¹
    if (!description) {
        showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†', 'error');
        return false;
    }
    
    if (!noAmountTypes.includes(type) && amount <= 0) {
        showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­', 'error');
        return false;
    }
    
    const currentDate = document.getElementById('currentDate').value || new Date().toISOString().split('T')[0];
    
    const newTransaction = {
        id: Date.now(),
        type: type,
        amount: amount,
        description: description,
        fund: fund,
        author: author,
        date: currentDate,
        time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
        timestamp: Date.now()
    };
    
    systemData.transactions.push(newTransaction);
    saveData();
    loadDailyTransactions();
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('descInput').value = '';
    if (!noAmountTypes.includes(type)) {
        document.getElementById('amountInput').value = '';
    }
    if (type === 'note') {
        document.getElementById('reportAuthor').value = '';
    }
    
    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†
    setTimeout(() => {
        document.getElementById('descInput').focus();
    }, 100);
    
    showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
    return false;
}

// ØªØ­Ø³ÙŠÙ† Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
function deleteTransaction(id) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) return;
    
    systemData.transactions = systemData.transactions.filter(tx => tx.id !== id);
    saveData();
    loadDailyTransactions();
    showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// ============================================
// Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†
// ============================================

// Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨
let lastActiveTab = 'daily';
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù†Ø§ÙØ°Ø©
        loadInitialData();
        
        if (lastActiveTab === 'daily') {
            loadDailyTransactions();
        } else if (lastActiveTab === 'deferred') {
            loadDeferredTransactions();
        }
    }
});

// Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
window.addEventListener('beforeunload', function() {
    saveData(true); // Ø­ÙØ¸ ÙÙˆØ±ÙŠ
});

// Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
setInterval(() => {
    if (document.visibilityState === 'visible') {
        saveData();
    }
}, 30000); // 30 Ø«Ø§Ù†ÙŠØ©

// ============================================
// ØªØ­Ø³ÙŠÙ†Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
// ============================================

// ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø±Ø¹ Ù„Ù„ØµÙˆØ±
function loadSavedImages() {
    const container = document.getElementById('savedImages');
    const noImagesMsg = document.getElementById('noImagesMessage');
    
    if (!container) return;
    
    container.innerHTML = '';
    
    if (systemData.images.length === 0) {
        noImagesMsg?.classList.remove('hidden');
        return;
    }
    
    noImagesMsg?.classList.add('hidden');
    
    // ØªØ­Ø³ÙŠÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
    const fragment = document.createDocumentFragment();
    const recentImages = systemData.images.slice(-20); // Ø¹Ø±Ø¶ Ø¢Ø®Ø± 20 ØµÙˆØ±Ø© ÙÙ‚Ø·
    
    recentImages.forEach(image => {
        const imageItem = document.createElement('div');
        imageItem.className = 'image-item';
        
        const img = document.createElement('img');
        img.src = image.data;
        img.className = 'image-preview';
        img.alt = image.name;
        img.loading = 'lazy'; // ØªØ­Ù…ÙŠÙ„ ÙƒØ³ÙˆÙ„ Ù„Ù„ØµÙˆØ±
        
        const removeBtn = document.createElement('div');
        removeBtn.className = 'image-remove';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.onclick = function() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©ØŸ')) {
                deleteImage(image.id);
            }
        };
        
        imageItem.appendChild(img);
        imageItem.appendChild(removeBtn);
        fragment.appendChild(imageItem);
    });
    
    container.appendChild(fragment);
}

// ============================================
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©
// ============================================

function initPage() {
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('currentDate').value = today;
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    loadInitialData();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    setTimeout(() => {
        loadDailyTransactions();
        initializeImageUpload();
        updateBalance(0);
        
        // Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ ÙƒØ§ØªØ¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        const authorField = document.getElementById('reportAuthorField');
        if (authorField) authorField.style.display = 'none';
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± ØªØ­Ù…ÙŠÙ„ Ø³Ù„Ø³
        document.body.style.opacity = '0';
        setTimeout(() => {
            document.body.style.transition = 'opacity 0.3s ease';
            document.body.style.opacity = '1';
        }, 50);
    }, 100);
    
    console.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù‘Ù† Ø¬Ø§Ù‡Ø² V8.1');
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    startAutoSync();
}

// Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
function startAutoSync() {
    // Ù…Ø²Ø§Ù…Ù†Ø© ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø´Ø§Ø·
    setInterval(() => {
        if (document.hasFocus()) {
            saveData();
        }
    }, 60000);
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const observer = new MutationObserver(() => {
        if (document.hasFocus()) {
            saveData();
        }
    });
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    const forms = document.querySelectorAll('form, input, select, textarea');
    forms.forEach(form => {
        observer.observe(form, {
            attributes: true,
            childList: true,
            subtree: true
        });
    });
}

// ============================================
// Ø¯Ø¹Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†
// ============================================

// Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± ÙƒØ§Ù…Ù„
function printDailyReport() {
    const date = document.getElementById('currentDate').value || new Date().toISOString().split('T')[0];
    const dateTransactions = systemData.transactions.filter(tx => tx.date === date);
    const dateDeferred = systemData.deferred.filter(def => def.date === date);
    
    const data = {
        transactions: dateTransactions,
        deferred: dateDeferred,
        images: systemData.images.filter(img => {
            const imgDate = new Date(img.date).toISOString().split('T')[0];
            return imgDate === date;
        }),
        totals: calculateTotals(dateTransactions, dateDeferred),
        summaries: generateSummaries(dateTransactions, dateDeferred)
    };
    
    printCompleteReport('combined', data, { startDate: date, endDate: date });
}

// ============================================
// Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…
// ============================================

// Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('DOMContentLoaded', initPage);

// ============================================
// ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø­Ø³Ù‘Ù†Ø©
// ============================================

function showMessage(message, type) {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø³Ø§Ø¦Ù„ Ø£Ø³Ø±Ø¹
    const messageEl = document.createElement('div');
    messageEl.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-3 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        type === 'warning' ? 'bg-yellow-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    messageEl.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(messageEl);
    
    // Ø¥Ø®ÙØ§Ø¡ Ø£Ø³Ø±Ø¹
    setTimeout(() => {
        messageEl.style.opacity = '0';
        messageEl.style.transition = 'opacity 0.3s ease';
        setTimeout(() => {
            if (messageEl.parentNode) {
                document.body.removeChild(messageEl);
            }
        }, 300);
    }, 3000);
}

function showLoader(text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...') {
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loaderText');
    
    if (loader && loaderText) {
        loaderText.textContent = text;
        loader.classList.add('active');
    }
}

function hideLoader() {
    const loader = document.getElementById('loader');
    if (loader) {
        loader.classList.remove('active');
    }
}

// Ø¨Ù‚ÙŠØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡...
</script>
</body>
</html>